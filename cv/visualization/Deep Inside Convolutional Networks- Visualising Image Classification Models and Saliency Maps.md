# [论文笔记] Deep Inside Convolutional Networks: Visualising Image Classification Models and Saliency Maps

## 摘要
基于计算关于输入图片的类别得分的梯度, 提出了两个可视化技术
- 对于被卷积神经网络捕捉到的类别, 生成一张最大化类别得分的图片
- 对于给定的图片其类别,计算一个类别的显著图

也展示了这些图可以通过分类任务的卷积神经网络, 应用到弱监督中的图像分割中.  
最后建立了一个基于梯度可视化方法和反卷积网络的连接

## 介绍
过往的工作:
- [Erhan](https://pdfs.semanticscholar.org/65d9/94fb778a8d9e0f632659fb33a082949a50d3.pdf) 采用梯度上升法去可视化最大化神经元的感兴趣的区域, 这是一种非监督的网络比如DBN
- [Zeiler](https://arxiv.org/abs/1311.2901) 采取了反卷积的方式去近似的从每一层的输出去重构输入

本文的贡献:
- 采用输入图像的数值优化可以获得卷积神经网络分类模型能够被理解的可视化. 在本文中采取的是监督式学习的方式, 所以我们知道在最后的全连接层知道哪一个神经元应该被最大化激活去可视化它的类别
- 提出了一个单纯的反向传播,来计算显著图
- 基于梯度的方法使得反卷积网络重构图像的过程更加的泛化.

## 分类模型可视化
通过一个已经学习了分类的ConvNet,和感兴趣的类,可视化在于数值化的生成一张图片,这张图片展示了ConvNet打分模型给予的类别.  
总体而言, 令 $S_c(I)$ 是类别 C 的得分, 这个得分是由分类层对于图片 $I$ 计算得到. 需要找到的是经过 $L_2$ 正则化后的图片, 使得 $S_c$ 的得分尽可能的高

$$\underset{I}{argmax} \ S_c(I) - \lambda ||I||^{2}_{2}$$

$\lambda$ 只是一个归一化参数, 局部最优的 $I$ 可以通过反向传播得到. 这个过程与ConvNet的训练步骤类似, 该步骤中BP被用于最优化层的权重. 不同的地方在于, 在这个方法中BP是去优化输入图片, 在这个过程中, 参数权值是被固定的.   

步骤:
- 固定好已经训练好的网络的参数权值
- 生成一个全0的输入图片
- 按照上式子的损失函数进行训练
- 将这张图片的结果和训练集中的图像平均值相加

值得注意的是, 这里使用的是没有经过softmax的 $S_c$. 原因是可以通过最小化分类得分来最大化分类后摇. 因此采用优化 $S_c$ 来确保优化仅仅是针对我们感兴趣的类别 C. 文中也写到尝试了优化 softmax 后的结果, 发现结果并不理想, 也证实了他们的想法.

## 特定图像的类别显著图
这一部分描述了在一个给定的图像中如何将分类ConvNet用于寻找一个特定类别的空间联系.

- 给定图片 $I_0$, 类别c和一个有得分函数 $S_c(I)$ 的分类ConvNet. 目的是对图像 $I_0$ 中所有的像素点对于分类得分 $S_c(I)$ 进行一个排序.

从一个简单的例子入手, 对于类别c考虑一个线性打分模型
$$S_c(I) = w^{T}_c I + b_c$$
$I$ 是图像一维向量化的结果. 从这个例子汇总可以轻松的看到 $w$ 的大小决定了对应像素 $I$ 对于类别c的重要性

对于深层的ConvNet, $S_c(I)$ 是一个 $I$ 的非线性函数. 所以上面的例子并不能奏效.然而给定一个图片 $I_0$ 可以近似的计算 $S_c(I)$, 通过**泰勒展开**的第一级

$$S_c(I) \approx w^{T}_c I + b$$

这里 $w$ 是 $S_c$ 关于图像 $I$ 在点(图像) $I_0$的导数

$$w = \frac{\partial S_c}{\partial I}|_ {I_0}$$

另一个为什么用导数计算类别显著图的原因是在于, 导数表明了哪一个像素可以在最小改变的情况下最大的影响类别分数

**所以相当于,对于一个特定的网络求取对应类别的打分函数的类别值对于原图像像素点的导数即是类别显著图**

## 分类显著图的提取
给定一个图像 $I_0$ 以及其类别 c, 其显著图 $M \in R^{m \times n}$ 计算方式:
- 导数 $w$ 通过反向传播计算得到
- 重新排列向量 $w$ 来得到显著图

对于灰度图
- $w$ 的元素个数要和 $I_0$ 的像素个数一致
- $M_{i,j} = |w_{h(i,j)}|$ 这里, $h(i,j)$ 对应的是图像中的第i行第j列

对与RGB图像
- 假设通道c的第 $(i,j)$ 个像素对应了 $w$ 中的 $h(i,j,c)$
- 为了对于每个像素 $(i,j)$ 上对某个类进行求导, 取各个通道上最大的 $w$ 使得 $M_{i,j} = max_c|w_{h(i,j,c)}|$

注意对于显著图只是通过label来提取, 所以多余的信息如物体的目标框或者分割的掩膜都是不需要的. 所以对于特定的图片计算显著图是非常快的, 因为只需要计算一次反向传播

本文只是显示了所有类别中得分最高的类.

## 弱监督目标定位
通过上一节的显著图可以对于给定图片和类别的目标进行位置编码, 因为可以做到目标定位. 计算目标分割掩膜通过GraphCut颜色分割. 这么做的原因在于, 显著图只能捕获目标中最能被区分的部分,所以显著的阈值可能没法把目标的其他部分显示出来.因此根据阈值延伸区域是非常重要的.将前景和后景按照高斯混合模型设置好. 前景模型阈值设置为整幅图片显著性的95%；背景色设置为整幅图最小的30%显著性。使用公开的算法实现GraphCut分割。一旦前景和背景的图像像素标签被计算完毕，目标分割的边缘被设置为前景像素的最大连通域.

*效果并不好*

## 与反卷积网络的关系
**待续, 反卷积网络的可视化**  
结论: 如了relu层,使用DeconvNet来计算近似特征图重构图片与使用BP计算相似.所以基于梯度的可视化被看作一种归纳, 因为基于梯度的技术可以被用于任何层活动的可视化, 不仅仅是卷积层

## 总结
这篇文章阐述了两个可视化技术
- 生成人工图像, 该图像代表了感兴趣的类
- 计算了特定类的图像的显著图, 根据类表明了给定图像的高亮区域
- 论述了与反卷积网络的联系
